以下是按照代码功能模块划分的详细说明，采用与示例文档相同的结构化格式：

---

### **数据库管理模块（DatabaseManager类）**

#### **1-9行：依赖导入**
- 导入MySQL连接池、类型注解等核心库
- 支持连接复用和线程安全操作

#### **11-39行：连接池初始化**
- 创建可复用的数据库连接池（5个连接）
- 配置主机、用户、密码、数据库名等参数
- 设置自动提交事务模式

#### **41-80行：核心数据库操作**
- `execute_query()`：执行查询并返回字典列表（用于SELECT）
- `execute_update()`：执行更新返回影响行数（用于INSERT/UPDATE/DELETE）
- 封装常用查询：用户ID转用户名、好友列表、群组列表等

---

### **认证服务模块（AuthService类）**

#### **83-120行：安全工具方法**
- `_hash_password()`：SHA-256加盐密码哈希
- `_verify_password()`：安全密码比对
- `_validate_username()`：用户名格式校验（3-20位字母数字）
- `_validate_email()`：简易邮箱格式校验

#### **122-180行：用户注册**
1. 校验输入格式
2. 检查用户名/邮箱冲突
3. 教师账号特殊验证
4. 密码哈希后入库
5. 返回用户ID或错误信息

#### **182-260行：用户登录**
- 失败尝试限制（5次锁定5分钟）
- 自动清理过期锁定记录
- 密码验证成功后重置计数器
- 返回用户基础信息或锁定状态

---

### **好友服务模块（FriendService类）**

#### **263-320行：好友关系管理**
- `send_request()`：发送好友请求（自动排序用户ID防重复）
- `handle_request()`：处理请求（接受/拒绝）
- `remove_friend()`：删除好友关系
- 状态检查：已存在关系验证

#### **322-350行：数据查询**
- `get_friends()`：获取完整好友列表（含在线状态）
- `get_pending_requests()`：查询待处理请求
- 关联用户表获取头像等附加信息

---

### **群组服务模块（GroupService类）**

#### **353-420行：群组管理**
- `create_group()`：创建群组（含初始成员批量添加）
  - 事务处理保证数据一致性
  - 自动设置创建者为owner角色
- `add_member()`：管理员添加成员（权限验证）

#### **422-450行：数据查询**
- `get_user_groups()`：获取用户所属群组列表
  - 包含成员数统计
  - 返回用户角色信息（owner/admin/member）

---

### **消息服务模块（MessageService类）**

#### **453-520行：消息收发**
- `send_message()`：发送消息（私聊/群聊）
  - 接收者存在性验证
  - 群组成员权限检查
  - 支持文本/文件消息类型
- 消息持久化存储

#### **522-580行：消息查询**
- `get_messages()`：获取历史消息
  - 私聊消息双向匹配（A→B和B→A）
  - 群聊消息按时间倒序
  - 分页支持（page/page_size参数）

---

### **系统架构特点**

1. **分层设计**
   - 数据库层：纯SQL操作封装
   - 服务层：业务逻辑实现

2. **安全机制**
   - 密码加盐哈希存储
   - 登录失败锁定
   - SQL参数化查询防注入

3. **扩展性**
   - 模块化服务类设计
   - 类型注解提升可维护性
   - 标准化的成功/错误响应格式

4. **性能优化**
   - 数据库连接池
   - 批量操作支持（如群组初始成员添加）
   - 消息分页查询

---
】